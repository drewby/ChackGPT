@rendermode InteractiveServer
@using Microsoft.AspNetCore.SignalR.Client
@using chackgpt.Web.Services
@inject NavigationManager Navigation
@inject IChatMessageService ChatMessageService
@implements IAsyncDisposable

<div class="chack-avatar">
    <img src="/images/chack/chack-@(currentEmotion).png" 
         alt="ChackGPT Avatar - @currentEmotion emotion" 
         class="chack-image" />
</div>

@inject ILogger<ChackAvatar> Logger

@code {
    private HubConnection? hubConnection;
    private string currentEmotion = "neutral";

    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("üé≠ ChackAvatar initializing...");

        
        // Connect to SignalR hub to receive emotion changes
        hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/chathub"))
            .WithAutomaticReconnect()
            .Build();

        // Listen for emotion changes
        hubConnection.On<string>("EmotionChanged", (emotion) =>
        {
            Logger.LogInformation("üé≠ ChackAvatar received EmotionChanged: {Emotion}", emotion);
            currentEmotion = emotion;
            Logger.LogInformation("üé≠ ChackAvatar updated currentEmotion to: {CurrentEmotion}", currentEmotion);
            InvokeAsync(StateHasChanged);
        });

        try
        {
            await hubConnection.StartAsync();
            Logger.LogInformation("‚úÖ ChackAvatar SignalR connection established");
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "‚ö†Ô∏è ChackAvatar failed to connect to SignalR hub");
            // If connection fails, avatar will show neutral emotion
            // This is acceptable as the avatar is decorative
        }
    }

    public async ValueTask DisposeAsync()
    {
        
        if (hubConnection is not null)
        {
            Logger.LogInformation("üé≠ ChackAvatar disposing SignalR connection");
            await hubConnection.DisposeAsync();
        }
    }
}
